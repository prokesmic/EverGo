generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  username        String    @unique
  password        String?
  displayName     String
  avatarUrl       String?
  coverPhotoUrl   String?
  bio             String?
  city            String?
  country         String?
  dateOfBirth     DateTime?
  gender          String?   // Enum: Gender
  privacyLevel    String    @default("PUBLIC") // Enum: PrivacyLevel
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  sports          UserSport[]
  activities      Activity[]
  personalRecords PersonalRecord[]
  rankings        Ranking[]
  posts           Post[]
  comments        Comment[]
  reactions       Reaction[]
  followers       Follow[]  @relation("following")
  following       Follow[]  @relation("follower")
  teamMemberships TeamMember[]
  sentFriendRequests     FriendRequest[] @relation("requester")
  receivedFriendRequests FriendRequest[] @relation("addressee")
}

model Sport {
  id              String    @id @default(cuid())
  name            String    @unique
  slug            String    @unique
  icon            String
  category        String    // Enum: SportCategory
  hasGpsTracking  Boolean   @default(false)
  
  disciplines     Discipline[]
  userSports      UserSport[]
  teams           Team[]
}

model Discipline {
  id              String    @id @default(cuid())
  sportId         String
  sport           Sport     @relation(fields: [sportId], references: [id])
  name            String
  slug            String
  measurementType String    // Enum: MeasurementType
  primaryMetric   String
  rankingFormula  String
  lowerIsBetter   Boolean   @default(true)
  
  activities      Activity[]
  personalRecords PersonalRecord[]
  rankings        Ranking[]
  
  @@unique([sportId, slug])
}

model UserSport {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sportId     String
  sport       Sport     @relation(fields: [sportId], references: [id])
  isPrimary   Boolean   @default(false)
  skillLevel  String?   // Enum: SkillLevel
  startedAt   DateTime?
  createdAt   DateTime  @default(now())
  
  @@unique([userId, sportId])
}

model Activity {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  disciplineId    String
  discipline      Discipline @relation(fields: [disciplineId], references: [id])
  
  title           String
  description     String?
  activityDate    DateTime
  durationSeconds Int?
  distanceMeters  Float?
  elevationGain   Float?
  caloriesBurned  Int?
  avgHeartRate    Int?
  maxHeartRate    Int?
  
  primaryValue    Float       // The main result (time in seconds, score, etc.)
  
  gpsRoute        String?     // Json is not supported in SQLite in the same way, but Prisma maps it to String usually. Wait, Prisma supports Json in SQLite.
  photos          String      // SQLite doesn't support String[], we need to serialize it or use a separate table. For simplicity, let's use a comma-separated string or JSON string.
  
  source          String      @default("MANUAL") // Enum: ActivitySource
  externalId      String?
  visibility      String      @default("PUBLIC") // Enum: PrivacyLevel
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  post            Post?
  
  @@index([userId, activityDate])
  @@index([disciplineId])
}

model Ranking {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  disciplineId    String
  discipline      Discipline @relation(fields: [disciplineId], references: [id])
  
  scope           String    // Enum: RankingScope
  scopeIdentifier String      // e.g., "Prague", "Czech Republic", "worldwide"
  
  position        Int
  totalParticipants Int
  percentile      Float
  score           Float
  
  period          String    // Enum: RankingPeriod
  periodValue     String?     // e.g., "2024", "2024-03"
  
  calculatedAt    DateTime  @default(now())
  
  @@unique([userId, disciplineId, scope, scopeIdentifier, period, periodValue])
  @@index([disciplineId, scope, scopeIdentifier, period])
}

model PersonalRecord {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  disciplineId    String
  discipline      Discipline @relation(fields: [disciplineId], references: [id])
  
  recordType      String      // e.g., "5K_TIME", "MARATHON_TIME"
  value           Float
  unit            String
  achievedAt      DateTime
  activityId      String?
  
  @@unique([userId, disciplineId, recordType])
}

model Follow {
  id          String    @id @default(cuid())
  followerId  String
  follower    User      @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User      @relation("following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  
  @@unique([followerId, followingId])
}

model FriendRequest {
  id          String    @id @default(cuid())
  requesterId String
  requester   User      @relation("requester", fields: [requesterId], references: [id], onDelete: Cascade)
  addresseeId String
  addressee   User      @relation("addressee", fields: [addresseeId], references: [id], onDelete: Cascade)
  status      String    @default("PENDING") // Enum: FriendRequestStatus
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([requesterId, addresseeId])
}

model Post {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postType    String    // Enum: PostType
  content     String?
  photos      String    // SQLite doesn't support String[], using String (JSON/CSV)
  
  activityId  String?   @unique
  activity    Activity? @relation(fields: [activityId], references: [id])
  
  visibility  String    @default("PUBLIC") // Enum: PrivacyLevel
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  comments    Comment[]
  reactions   Reaction[]
}

model Comment {
  id        String    @id @default(cuid())
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime  @default(now())
}

model Reaction {
  id           String    @id @default(cuid())
  postId       String
  post         Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactionType String    // Enum: ReactionType
  createdAt    DateTime  @default(now())
  
  @@unique([postId, userId])
}

model Team {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  description   String?
  sportId       String
  sport         Sport     @relation(fields: [sportId], references: [id])
  logoUrl       String?
  coverPhotoUrl String?
  location      String?
  teamType      String    // Enum: TeamType
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  
  members       TeamMember[]
}

model TeamMember {
  id          String    @id @default(cuid())
  teamId      String
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        String    // Enum: TeamRole
  jerseyNumber String?
  position    String?
  joinedAt    DateTime  @default(now())
  
  @@unique([teamId, userId])
}
